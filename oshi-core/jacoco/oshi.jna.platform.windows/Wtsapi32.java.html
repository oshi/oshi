<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Wtsapi32.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">oshi-core</a> &gt; <a href="index.source.html" class="el_package">oshi.jna.platform.windows</a> &gt; <span class="el_source">Wtsapi32.java</span></div><h1>Wtsapi32.java</h1><pre class="source lang-java linenums">/**
 * MIT License
 *
 * Copyright (c) 2010 - 2020 The OSHI Project Contributors: https://github.com/oshi/oshi/graphs/contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the &quot;Software&quot;), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package oshi.jna.platform.windows;

import com.sun.jna.Native; // NOSONAR squid:S1191
import com.sun.jna.Pointer;
import com.sun.jna.Structure;
import com.sun.jna.Structure.FieldOrder;
import com.sun.jna.platform.win32.WinNT.HANDLE;
import com.sun.jna.ptr.IntByReference;
import com.sun.jna.ptr.PointerByReference;
import com.sun.jna.win32.W32APIOptions;
import com.sun.jna.win32.W32APITypeMapper;

import oshi.jna.platform.windows.WinNT.LARGE_INTEGER;

public interface Wtsapi32 extends com.sun.jna.platform.win32.Wtsapi32 {

<span class="nc" id="L40">    Wtsapi32 INSTANCE = Native.load(&quot;Wtsapi32&quot;, Wtsapi32.class, W32APIOptions.DEFAULT_OPTIONS);</span>
    /**
     * Defined in {@code winsta.h} and present in this interface to properly size
     * the {@link WTSINFO} structure.
     */
    int DOMAIN_LENGTH = 17;

    /**
     * Defined in {@code winsta.h} and present in this interface to properly size
     * the {@link WTSINFO} structure.
     */
    int USERNAME_LENGTH = 20;

    /**
     * Defined in {@code winsta.h} and present in this interface to properly size
     * the {@link WTSINFO} structure.
     */
    int WINSTATIONNAME_LENGTH = 32;

    /**
     * Specifies the connection state of a Remote Desktop Services session.
     */
    public interface WTS_CONNECTSTATE_CLASS {
        int WTSActive = 0;
        int WTSConnected = 1;
        int WTSConnectQuery = 2;
        int WTSShadow = 3;
        int WTSDisconnected = 4;
        int WTSIdle = 5;
        int WTSListen = 6;
        int WTSReset = 7;
        int WTSDown = 8;
        int WTSInit = 9;
    }

    /**
     * Contains values that indicate the type of session information to retrieve in
     * a call to the {@code WTSQuerySessionInformation()} function.
     */
    public interface WTS_INFO_CLASS {
        int WTSInitialProgram = 0;
        int WTSApplicationName = 1;
        int WTSWorkingDirectory = 2;
        int WTSOEMId = 3;
        int WTSSessionId = 4;
        int WTSUserName = 5;
        int WTSWinStationName = 6;
        int WTSDomainName = 7;
        int WTSConnectState = 8;
        int WTSClientBuildNumber = 9;
        int WTSClientName = 10;
        int WTSClientDirectory = 11;
        int WTSClientProductId = 12;
        int WTSClientHardwareId = 13;
        int WTSClientAddress = 14;
        int WTSClientDisplay = 15;
        int WTSClientProtocolType = 16;
        int WTSIdleTime = 17;
        int WTSLogonTime = 18;
        int WTSIncomingBytes = 19;
        int WTSOutgoingBytes = 20;
        int WTSIncomingFrames = 21;
        int WTSOutgoingFrames = 22;
        int WTSClientInfo = 23;
        int WTSSessionInfo = 24;
        int WTSSessionInfoEx = 25;
        int WTSConfigInfo = 26;
        int WTSValidationInfo = 27;
        int WTSSessionAddressV4 = 28;
        int WTSIsRemoteSession = 29;
    }

    /**
     * Contains information about a client session on a Remote Desktop Session Host
     * (RD Session Host) server.
     */
    @FieldOrder({ &quot;SessionId&quot;, &quot;pWinStationName&quot;, &quot;State&quot; })
    class WTS_SESSION_INFO extends Structure {
        public int SessionId;
        public String pWinStationName; // either LPSTR or LPWSTR
        public int State; // WTS_CONNECTSTATE_CLASS

        public WTS_SESSION_INFO() {
<span class="nc" id="L123">            super(W32APITypeMapper.DEFAULT);</span>
<span class="nc" id="L124">        }</span>

        public WTS_SESSION_INFO(Pointer p) {
<span class="nc" id="L127">            super(p, Structure.ALIGN_DEFAULT, W32APITypeMapper.DEFAULT);</span>
<span class="nc" id="L128">            read();</span>
<span class="nc" id="L129">        }</span>
    }

    /**
     * Contains the client network address of a Remote Desktop Services session.
     */
    @FieldOrder({ &quot;AddressFamily&quot;, &quot;Address&quot; })
    class WTS_CLIENT_ADDRESS extends Structure {
        public int AddressFamily;
<span class="nc" id="L138">        public byte[] Address = new byte[20];</span>

        public WTS_CLIENT_ADDRESS() {
<span class="nc" id="L141">            super();</span>
<span class="nc" id="L142">        }</span>

        public WTS_CLIENT_ADDRESS(Pointer p) {
<span class="nc" id="L145">            super(p);</span>
<span class="nc" id="L146">            read();</span>
<span class="nc" id="L147">        }</span>
    }

    /**
     * Contains information about a Remote Desktop Services session.
     */
    @FieldOrder({ &quot;State&quot;, &quot;SessionId&quot;, &quot;IncomingBytes&quot;, &quot;OutgoingBytes&quot;, &quot;IncomingFrames&quot;, &quot;OutgoingFrames&quot;,
            &quot;IncomingCompressedBytes&quot;, &quot;OutgoingCompressedBytes&quot;, &quot;WinStationName&quot;, &quot;Domain&quot;, &quot;UserName&quot;, &quot;ConnectTime&quot;,
            &quot;DisconnectTime&quot;, &quot;LastInputTime&quot;, &quot;LogonTime&quot;, &quot;CurrentTime&quot; })
    class WTSINFO extends Structure {
<span class="nc bnc" id="L157" title="All 2 branches missed.">        private static final int CHAR_WIDTH = Boolean.getBoolean(&quot;w32.ascii&quot;) ? 1 : 2;</span>

        public int State; // WTS_CONNECTSTATE_CLASS
        public int SessionId;
        public int IncomingBytes;
        public int OutgoingBytes;
        public int IncomingFrames;
        public int OutgoingFrames;
        public int IncomingCompressedBytes;
        public int OutgoingCompressedBytes;
<span class="nc" id="L167">        public final byte[] WinStationName = new byte[WINSTATIONNAME_LENGTH * CHAR_WIDTH];</span>
<span class="nc" id="L168">        public final byte[] Domain = new byte[DOMAIN_LENGTH * CHAR_WIDTH];</span>
<span class="nc" id="L169">        public final byte[] UserName = new byte[(USERNAME_LENGTH + 1) * CHAR_WIDTH];</span>
        public LARGE_INTEGER ConnectTime;
        public LARGE_INTEGER DisconnectTime;
        public LARGE_INTEGER LastInputTime;
        public LARGE_INTEGER LogonTime;
        public LARGE_INTEGER CurrentTime;

        public WTSINFO() {
<span class="nc" id="L177">            super();</span>
<span class="nc" id="L178">        }</span>

        public WTSINFO(Pointer p) {
<span class="nc" id="L181">            super(p);</span>
<span class="nc" id="L182">            read();</span>
<span class="nc" id="L183">        }</span>

        /**
         * Convenience method to return the null-terminated string in the
         * {@link #WinStationName} member, accounting for {@code CHAR} or {@code WCHAR}
         * byte width.
         *
         * @return The {@code WinStationName} as a string.
         */
        public String getWinStationName() {
<span class="nc" id="L193">            return getStringAtOffset(fieldOffset(&quot;WinStationName&quot;));</span>
        }

        /**
         * Convenience method to return the null-terminated string in the
         * {@link #Domain} member, accounting for {@code CHAR} or {@code WCHAR} byte
         * width.
         *
         * @return The {@code Domain} as a string.
         */
        public String getDomain() {
<span class="nc" id="L204">            return getStringAtOffset(fieldOffset(&quot;Domain&quot;));</span>
        }

        /**
         * Convenience method to return the null-terminated string in the
         * {@link #UserName} member, accounting for {@code CHAR} or {@code WCHAR} byte
         * width.
         *
         * @return The {@code UserName} as a string.
         */
        public String getUserName() {
<span class="nc" id="L215">            return getStringAtOffset(fieldOffset(&quot;UserName&quot;));</span>
        }

        private String getStringAtOffset(int offset) {
<span class="nc bnc" id="L219" title="All 2 branches missed.">            return CHAR_WIDTH == 1 ? getPointer().getString(offset) : getPointer().getWideString(offset);</span>
        }
    }

    /**
     * Retrieves a list of sessions on a Remote Desktop Session Host (RD Session
     * Host) server.
     *
     * @param hServer
     *            A handle to the RD Session Host server.
     *            &lt;p&gt;
     *            You can use the {@code WTSOpenServer} or {@code WTSOpenServerEx}
     *            functions to retrieve a handle to a specific server, or
     *            {@link #WTS_CURRENT_SERVER_HANDLE} to use the RD Session Host
     *            server that hosts your application.
     * @param Reserved
     *            This parameter is reserved. It must be zero.
     * @param Version
     *            The version of the enumeration request. This parameter must be 1.
     * @param ppSessionInfo
     *            A pointer to an array of {@link WTS_SESSION_INFO} structures that
     *            represent the retrieved sessions. To free the returned buffer,
     *            call the {@link Wtsapi32#WTSFreeMemory} function.
     * @param pCount
     *            A pointer to the number of {@code WTS_SESSION_INFO} structures
     *            returned in the {@code ppSessionInfo} parameter.
     * @return Returns {@code false} if this function fails. If this function
     *         succeeds, returns {@code true}.
     *         &lt;p&gt;
     *         To get extended error information, call
     *         {@link Kernel32#GetLastError()}.
     */
    boolean WTSEnumerateSessions(HANDLE hServer, int Reserved, int Version, PointerByReference ppSessionInfo,
            IntByReference pCount);

    /**
     * Retrieves session information for the specified session on the specified
     * Remote Desktop Session Host (RD Session Host) server. It can be used to query
     * session information on local and remote RD Session Host servers.
     *
     * @param hServer
     *            A handle to an RD Session Host server. Specify a handle opened by
     *            the {@code WTSOpenServer} function, or specify
     *            {@link #WTS_CURRENT_SERVER_HANDLE} to indicate the RD Session Host
     *            server on which your application is running.
     * @param SessionId
     *            A Remote Desktop Services session identifier. To indicate the
     *            session in which the calling application is running (or the
     *            current session) specify {@link #WTS_CURRENT_SESSION}. Only
     *            specify {@code WTS_CURRENT_SESSION} when obtaining session
     *            information on the local server. If {@code WTS_CURRENT_SESSION} is
     *            specified when querying session information on a remote server,
     *            the returned session information will be inconsistent. Do not use
     *            the returned data.
     *            &lt;p&gt;
     *            You can use the {@code WTSEnumerateSessionsEx} function to
     *            retrieve the identifiers of all sessions on a specified RD Session
     *            Host server.
     *            &lt;p&gt;
     *            To query information for another user's session, you must have
     *            Query Information permission.
     * @param WTSInfoClass
     *            A value of the {@link WTS_INFO_CLASS} enumeration that indicates
     *            the type of session information to retrieve in a call to the
     *            {@code WTSQuerySessionInformation} function.
     * @param ppBuffer
     *            A pointer to a variable that receives a pointer to the requested
     *            information. The format and contents of the data depend on the
     *            information class specified in the {@code WTSInfoClass} parameter.
     *            To free the returned buffer, call the {@link #WTSFreeMemory}
     *            function.
     * @param pBytesReturned
     *            A pointer to a variable that receives the size, in bytes, of the
     *            data returned in ppBuffer.
     * @return If the function succeeds, returns {@code true}.
     *         &lt;p&gt;
     *         If the function fails, returns {@code false}. To get extended error
     *         information, call {@link Kernel32#GetLastError()}.
     */
    boolean WTSQuerySessionInformation(HANDLE hServer, int SessionId, int WTSInfoClass, PointerByReference ppBuffer,
            IntByReference pBytesReturned);

    /**
     * Frees memory allocated by a Remote Desktop Services function.
     *
     * @param pMemory
     *            Pointer to the memory to free.
     */
    void WTSFreeMemory(Pointer pMemory);
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>